<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2A593E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Lightsprouts | Premium Seeds</title>
    
    <!-- Firebase SDK (Modular v12) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
                sendPasswordResetEmail, signInWithPhoneNumber, RecaptchaVerifier, onAuthStateChanged, signOut } 
                from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAHrBE3doAhDni4mcNhylJD8o3r5cNZYSI",
            authDomain: "ls-mannage.firebaseapp.com",
            databaseURL: "https://ls-mannage-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ls-mannage",
            storageBucket: "ls-mannage.firebasestorage.app",
            messagingSenderId: "115534926798",
            appId: "1:115534926798:web:4ea3ab3c1a2d44e2e1d19f",
            measurementId: "G-P2JQH8M41Y"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase available globally
        window.firebaseAuth = {
            auth,
            database,
            googleProvider,
            signInWithPopup,
            signInWithPhoneNumber,
            RecaptchaVerifier,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged,
            signOut,
            ref,
            set,
            get
        };
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        forest: '#2A593E',        
                        leaf: '#7ED957',          
                        lime: '#D1FFBD',          
                        mint: '#F0FFE9',          
                        sand: '#fcfdfa',
                        dark: '#081C15'
                    },
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(42, 89, 62, 0.15)',
                        'glow': '0 0 20px rgba(126, 217, 87, 0.4)',
                        'popup': '0 25px 50px -12px rgba(42, 89, 62, 0.25)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            background-color: #fcfdfa;
            color: #2A593E;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn-large {
            padding: 16px 24px;
            font-size: 16px;
        }
        
        .recaptcha-container {
            margin: 20px auto;
            display: flex;
            justify-content: center;
        }
        
        .otp-input {
            letter-spacing: 10px;
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Modal animations */
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        
        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="font-sans antialiased min-h-screen relative flex flex-col pb-28 md:pb-0">

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 z-[100] bg-gradient-to-br from-mint to-leaf flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="mb-8">
            <div class="w-24 h-24 rounded-full overflow-hidden">
                <img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExd3Q1NnZyN21kMm1yNTJ2aGdwdDltcmlxamtqNDYxMzZmM2xrYngzZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/B2bZ5FhOnTRvvkOIZn/giphy.gif" 
                     alt="Loading" 
                     class="w-full h-full object-cover">
            </div>
        </div>
        <h1 class="text-4xl font-serif font-bold text-forest mb-2">
            lightsprouts<span class="text-leaf">.</span>
        </h1>
        <p class="text-forest/80 font-medium tracking-wider text-xs uppercase">Growing Your Green Dreams</p>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 z-[999] flex items-center justify-center px-4 pointer-events-none opacity-0 invisible transition-all duration-300">
        <div class="absolute inset-0 bg-forest/90 backdrop-blur-sm" onclick="closeAuthModal()"></div>
        
        <div class="relative w-full max-w-md bg-white rounded-3xl shadow-popup overflow-hidden transform scale-95 transition-all duration-300 pointer-events-auto flex flex-col max-h-[90vh] border border-leaf/20 modal-enter">
            
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 z-30 w-10 h-10 rounded-full bg-white flex items-center justify-center text-forest border-2 border-forest/20 hover:bg-forest hover:text-white transition-all touch-target">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
                <button id="login-tab" class="flex-1 py-4 text-center font-bold text-forest border-b-2 border-forest transition-all touch-target" onclick="switchAuthTab('login')">
                    Login
                </button>
                <button id="register-tab" class="flex-1 py-4 text-center font-bold text-gray-400 transition-all touch-target" onclick="switchAuthTab('register')">
                    Register
                </button>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="p-6">
                <div class="text-center mb-6">
                    <div class="w-14 h-14 bg-mint rounded-full flex items-center justify-center mx-auto mb-3 text-leaf">
                        <i data-lucide="sprout" class="w-7 h-7"></i>
                    </div>
                    <h3 class="text-xl font-serif font-bold text-forest">Welcome Back</h3>
                </div>

                <form id="login-email-form" class="space-y-4" onsubmit="loginWithEmail(event)">
                    <div>
                        <label class="block text-sm font-medium text-forest mb-1">Email</label>
                        <input type="email" id="login-email" required placeholder="your@email.com" 
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-forest mb-1">Password</label>
                        <input type="password" id="login-password" required placeholder="••••••••" 
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                    </div>
                    
                    <button type="submit" class="w-full bg-forest text-white font-bold py-4 rounded-xl mt-4 shadow-lg hover:bg-[#1e3f2d] transition-colors btn-large">
                        Sign In
                    </button>
                </form>

                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="mx-4 text-gray-400 text-sm">Or continue with</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="signInWithGoogle()" class="bg-white border border-gray-200 text-forest font-semibold py-3.5 rounded-xl flex items-center justify-center gap-3 shadow-sm hover:bg-gray-50 transition-colors btn-medium touch-target">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Google
                    </button>
                    
                    <button onclick="openPhoneOTPModal()" class="bg-white border border-gray-200 text-forest font-semibold py-3.5 rounded-xl flex items-center justify-center gap-3 shadow-sm hover:bg-gray-50 transition-colors btn-medium touch-target">
                        <i data-lucide="phone" class="w-5 h-5"></i>
                        Phone OTP
                    </button>
                </div>
                
                <div class="text-center mt-4">
                    <button onclick="showForgotPassword()" class="text-sm text-forest hover:text-leaf font-medium touch-target">
                        Forgot password?
                    </button>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="p-6 hidden">
                <div class="text-center mb-6">
                    <div class="w-14 h-14 bg-mint rounded-full flex items-center justify-center mx-auto mb-3 text-leaf">
                        <i data-lucide="seedling" class="w-7 h-7"></i>
                    </div>
                    <h3 class="text-xl font-serif font-bold text-forest">Join Our Community</h3>
                </div>

                <form id="register-email-form" class="space-y-4" onsubmit="registerWithEmail(event)">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-forest mb-1">First Name</label>
                            <input type="text" id="register-firstname" required placeholder="John" 
                                   class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-forest mb-1">Last Name</label>
                            <input type="text" id="register-lastname" required placeholder="Doe" 
                                   class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-forest mb-1">Phone Number</label>
                        <input type="tel" id="register-phone" required placeholder="+91 9876543210" 
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-forest mb-1">Address</label>
                        <textarea id="register-address" required placeholder="Full delivery address" rows="2"
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all resize-none placeholder:text-gray-400 touch-target"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-forest mb-1">Email</label>
                        <input type="email" id="register-email" required placeholder="your@email.com" 
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-forest mb-1">Password</label>
                        <input type="password" id="register-password" required placeholder="••••••••" 
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                        <p class="text-xs text-gray-400 mt-1">Minimum 6 characters</p>
                    </div>
                    
                    <label class="flex items-start touch-target">
                        <input type="checkbox" id="terms" required
                               class="w-4 h-4 text-leaf bg-gray-100 border-gray-300 rounded focus:ring-leaf/20 focus:ring-2 mt-1">
                        <span class="ml-2 text-sm text-gray-600">I agree to the Terms & Privacy Policy</span>
                    </label>
                    
                    <button type="submit" class="w-full bg-leaf text-forest font-bold py-4 rounded-xl mt-4 shadow-lg hover:bg-[#6ec248] transition-colors btn-large">
                        Create Account
                    </button>
                </form>

                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="mx-4 text-gray-400 text-sm">Or sign up with</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="signInWithGoogle()" class="bg-white border border-gray-200 text-forest font-semibold py-3.5 rounded-xl flex items-center justify-center gap-3 shadow-sm hover:bg-gray-50 transition-colors btn-medium touch-target">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Google
                    </button>
                    
                    <button onclick="openPhoneOTPModal()" class="bg-white border border-gray-200 text-forest font-semibold py-3.5 rounded-xl flex items-center justify-center gap-3 shadow-sm hover:bg-gray-50 transition-colors btn-medium touch-target">
                        <i data-lucide="phone" class="w-5 h-5"></i>
                        Phone OTP
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PHONE OTP MODAL (New - with OTP verification) -->
    <div id="phone-otp-modal" class="fixed inset-0 z-[1001] flex items-center justify-center px-4 pointer-events-none opacity-0 invisible transition-all duration-300">
        <div class="absolute inset-0 bg-forest/90 backdrop-blur-sm" onclick="closePhoneOTPModal()"></div>
        
        <div class="relative w-full max-w-sm bg-white rounded-3xl shadow-popup overflow-hidden transform scale-95 transition-all duration-300 pointer-events-auto p-6 border border-leaf/20 modal-enter">
            
            <button onclick="closePhoneOTPModal()" class="absolute top-4 right-4 z-30 w-10 h-10 rounded-full bg-white flex items-center justify-center text-forest border-2 border-forest/20 hover:bg-forest hover:text-white transition-all touch-target">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <!-- Phone Input Stage -->
            <div id="phone-input-stage">
                <div class="text-center mb-6">
                    <div class="w-14 h-14 bg-mint rounded-full flex items-center justify-center mx-auto mb-3 text-leaf">
                        <i data-lucide="phone" class="w-7 h-7"></i>
                    </div>
                    <h3 class="text-xl font-serif font-bold text-forest">Phone Verification</h3>
                    <p class="text-gray-400 text-sm mt-2">Enter your phone number with country code</p>
                </div>

                <form id="phone-form" class="space-y-4" onsubmit="sendOTP(event)">
                    <div>
                        <label class="block text-sm font-medium text-forest mb-1">Phone Number</label>
                        <input type="tel" id="phone-number" required placeholder="+91 9876543210" 
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                        <p class="text-xs text-gray-400 mt-1">Example: +1 6505551234 or +91 9876543210</p>
                    </div>
                    
                    <!-- reCAPTCHA Container -->
                    <div id="recaptcha-container" class="recaptcha-container"></div>
                    
                    <button type="submit" id="send-otp-btn" class="w-full bg-forest text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#1e3f2d] transition-colors btn-large touch-target">
                        Send OTP
                    </button>
                </form>
            </div>

            <!-- OTP Verification Stage (Hidden Initially) -->
            <div id="otp-verification-stage" class="hidden">
                <div class="text-center mb-6">
                    <div class="w-14 h-14 bg-mint rounded-full flex items-center justify-center mx-auto mb-3 text-leaf">
                        <i data-lucide="shield-check" class="w-7 h-7"></i>
                    </div>
                    <h3 class="text-xl font-serif font-bold text-forest">Verify OTP</h3>
                    <p class="text-gray-400 text-sm mt-2" id="otp-sent-to">Enter the 6-digit code sent to</p>
                </div>

                <form id="otp-form" class="space-y-6" onsubmit="verifyOTP(event)">
                    <div class="text-center">
                        <input type="text" id="otp-code" maxlength="6" required 
                               class="otp-input w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-center text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all touch-target"
                               placeholder="000000"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        <p class="text-xs text-gray-400 mt-2">Enter the 6-digit code from SMS</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button type="submit" id="verify-otp-btn" class="w-full bg-leaf text-forest font-bold py-4 rounded-xl shadow-lg hover:bg-[#6ec248] transition-colors btn-large touch-target">
                            Verify OTP
                        </button>
                        
                        <button type="button" onclick="resendOTP()" id="resend-otp-btn" class="w-full text-forest hover:text-leaf font-medium py-3 text-sm touch-target" disabled>
                            Resend OTP (<span id="resend-timer">60</span>s)
                        </button>
                        
                        <button type="button" onclick="showPhoneInputStage()" class="w-full text-gray-400 hover:text-forest font-medium py-2 text-sm touch-target">
                            Use different number
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- FORGOT PASSWORD MODAL -->
    <div id="forgot-password-modal" class="fixed inset-0 z-[1002] flex items-center justify-center px-4 pointer-events-none opacity-0 invisible transition-all duration-300">
        <div class="absolute inset-0 bg-forest/90 backdrop-blur-sm" onclick="closeForgotPassword()"></div>
        
        <div class="relative w-full max-w-sm bg-white rounded-3xl shadow-popup overflow-hidden transform scale-95 transition-all duration-300 pointer-events-auto p-6 border border-leaf/20 modal-enter">
            
            <button onclick="closeForgotPassword()" class="absolute top-4 right-4 z-30 w-10 h-10 rounded-full bg-white flex items-center justify-center text-forest border-2 border-forest/20 hover:bg-forest hover:text-white transition-all touch-target">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-mint rounded-full flex items-center justify-center mx-auto mb-3 text-leaf">
                    <i data-lucide="key" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-serif font-bold text-forest">Reset Password</h3>
                <p class="text-gray-400 text-sm mt-2">Enter your email to reset password</p>
            </div>

            <form id="forgot-password-form" class="space-y-4" onsubmit="resetPassword(event)">
                <div>
                    <label class="block text-sm font-medium text-forest mb-1">Email Address</label>
                    <input type="email" id="reset-email" required placeholder="your@email.com" 
                           class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:ring-2 focus:ring-leaf/20 focus:border-leaf transition-all placeholder:text-gray-400 touch-target">
                </div>
                
                <button type="submit" class="w-full bg-forest text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#1e3f2d] transition-colors btn-large">
                    Send Reset Link
                </button>
                
                <button type="button" onclick="closeForgotPassword(); switchAuthTab('login')" 
                        class="w-full text-forest hover:text-leaf font-medium py-2 touch-target">
                    Back to Login
                </button>
            </form>
        </div>
    </div>

    <!-- APP HEADER -->
    <header class="fixed top-0 left-0 w-full z-40 bg-white/90 backdrop-blur-lg border-b border-gray-100">
        <div class="bg-forest py-2">
            <div class="flex items-center justify-center gap-4 overflow-x-auto no-scrollbar px-4">
                <div class="flex items-center gap-2">
                    <i data-lucide="sprout" class="w-3 h-3 text-lime"></i>
                    <span class="text-white text-xs font-bold">Premium Organic Seeds</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-3 h-3 text-lime"></i>
                    <span class="text-white text-xs font-bold">95% Germination</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="truck" class="w-3 h-3 text-lime"></i>
                    <span class="text-white text-xs font-bold">Free Shipping ₹500+</span>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 md:h-16 flex justify-between items-center">
            <a href="#" onclick="window.scrollTo({top:0,behavior:'smooth'}); return false;" class="text-xl md:text-2xl font-serif font-bold text-forest flex items-center gap-1 select-none touch-target">
                <div class="w-8 h-8 rounded-full bg-forest flex items-center justify-center text-lime shadow-lg">
                    <i data-lucide="sprout" class="w-5 h-5 fill-current"></i>
                </div>
                lightsprouts
            </a>

            <nav class="hidden md:flex items-center gap-1 bg-gray-100/50 p-1 rounded-full border border-gray-200">
                <button onclick="filterProducts('all')" class="nav-pill px-5 py-1.5 rounded-full text-sm font-bold bg-white text-forest shadow-sm border border-gray-100 touch-target">All</button>
                <button onclick="filterProducts('fruit-seeds')" class="nav-pill px-5 py-1.5 rounded-full text-sm font-semibold text-gray-500 hover:text-forest hover:bg-white/50 transition-all touch-target">Fruits</button>
                <button onclick="filterProducts('vegetable-seeds')" class="nav-pill px-5 py-1.5 rounded-full text-sm font-semibold text-gray-500 hover:text-forest hover:bg-white/50 transition-all touch-target">Veg</button>
                <button onclick="filterProducts('plant-seeds')" class="nav-pill px-5 py-1.5 rounded-full text-sm font-semibold text-gray-500 hover:text-forest hover:bg-white/50 transition-all touch-target">Plants</button>
            </nav>

            <div class="flex items-center gap-2 md:gap-3">
                <div id="user-profile" class="hidden items-center gap-2">
                    <div class="w-9 h-9 rounded-full bg-mint flex items-center justify-center text-leaf font-bold shadow-sm touch-target" id="user-avatar">
                        U
                    </div>
                    <div class="hidden md:block">
                        <p class="text-xs font-bold text-forest" id="user-name">User</p>
                        <button onclick="logout()" class="text-[10px] text-gray-400 hover:text-red-500 touch-target">Logout</button>
                    </div>
                </div>

                <button id="login-button" onclick="openAuthModal()" class="flex items-center gap-2 px-4 py-2.5 rounded-full text-sm font-semibold text-forest hover:bg-forest/5 transition-colors touch-target btn-medium">
                    <i data-lucide="log-in" class="w-4 h-4"></i>
                    <span class="hidden md:inline">Login</span>
                </button>

                <button onclick="openCart()" class="relative w-10 h-10 md:w-11 md:h-11 flex items-center justify-center rounded-full bg-forest text-white shadow-lg hover:bg-forest/90 transition-all touch-target">
                    <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-leaf text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center opacity-0 scale-0 transition-all duration-300 border border-white shadow-sm">0</span>
                </button>
            </div>
        </div>

        <div class="md:hidden w-full bg-white/95 backdrop-blur-lg border-b border-gray-100 py-3 px-4 overflow-x-auto no-scrollbar flex gap-2 snap-x">
            <button onclick="filterProducts('all')" class="snap-start whitespace-nowrap px-4 py-2.5 rounded-full text-sm font-bold bg-forest text-white shadow-sm border border-transparent touch-target">All Seeds</button>
            <button onclick="filterProducts('fruit-seeds')" class="snap-start whitespace-nowrap px-4 py-2.5 rounded-full text-sm font-bold bg-white text-forest border border-gray-200 touch-target">Fruits</button>
            <button onclick="filterProducts('vegetable-seeds')" class="snap-start whitespace-nowrap px-4 py-2.5 rounded-full text-sm font-bold bg-white text-forest border border-gray-200 touch-target">Vegetables</button>
            <button onclick="filterProducts('plant-seeds')" class="snap-start whitespace-nowrap px-4 py-2.5 rounded-full text-sm font-bold bg-white text-forest border border-gray-200 touch-target">Herbs</button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow pt-[8.5rem] md:pt-36 px-4 sm:px-6 w-full max-w-7xl mx-auto z-10 relative">
        
        <!-- Hero Section -->
        <section class="relative w-full h-[40vh] md:h-[400px] rounded-2xl overflow-hidden mb-6 shadow-lg">
            <img id="hero-img" src="https://images.unsplash.com/photo-1530836369250-ef72a3f5cda8?q=80&w=2070&auto=format&fit=crop&w=800" 
                 loading="lazy"
                 class="absolute inset-0 w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-dark/80 via-dark/20 to-transparent"></div>
            
            <div class="absolute bottom-0 left-0 w-full p-6 md:p-8 flex flex-col items-start text-white">
                <h1 class="text-3xl md:text-5xl font-serif font-bold mb-3 leading-tight">
                    Grow your <br><span class="text-lime italic">sanctuary.</span>
                </h1>
                <button onclick="scrollToGrid()" class="bg-leaf text-forest font-bold py-3 px-6 rounded-xl hover:bg-lime transition-all flex items-center gap-2 shadow-lg btn-large mt-2">
                    Start Growing <i data-lucide="arrow-down" class="w-4 h-4"></i>
                </button>
            </div>
        </section>

        <!-- Stats Bar -->
        <div class="grid grid-cols-3 gap-2 mb-8 bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
            <div class="text-center">
                <p class="text-2xl font-serif font-bold text-forest">95%</p>
                <p class="text-xs font-bold text-gray-400 uppercase">Germination</p>
            </div>
            <div class="text-center border-l border-gray-200">
                <p class="text-2xl font-serif font-bold text-forest">100%</p>
                <p class="text-xs font-bold text-gray-400 uppercase">Organic</p>
            </div>
            <div class="text-center border-l border-gray-200">
                <p class="text-2xl font-serif font-bold text-forest">24/7</p>
                <p class="text-xs font-bold text-gray-400 uppercase">Support</p>
            </div>
        </div>

        <!-- Product Grid Header -->
        <div id="grid-anchor" class="flex items-end justify-between mb-4 px-1">
            <div>
                <h2 class="text-xl md:text-2xl font-serif font-bold text-forest flex items-center gap-2">
                    Curated Seeds
                    <span id="item-count-badge" class="bg-forest/10 text-forest text-xs px-2 py-0.5 rounded-full font-sans font-bold align-middle">8</span>
                </h2>
            </div>
        </div>

        <!-- Product Grid -->
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 mb-24">
            <!-- Products will be loaded here -->
            <div class="rounded-2xl overflow-hidden aspect-[4/5] bg-gray-100 animate-pulse"></div>
            <div class="rounded-2xl overflow-hidden aspect-[4/5] bg-gray-100 animate-pulse"></div>
            <div class="rounded-2xl overflow-hidden aspect-[4/5] bg-gray-100 animate-pulse"></div>
            <div class="rounded-2xl overflow-hidden aspect-[4/5] bg-gray-100 animate-pulse"></div>
        </div>

    </main>

    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-xl border-t border-gray-200 z-40 flex justify-around items-center pt-3 pb-1" style="padding-bottom: calc(15px + var(--safe-bottom))">
        <button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="flex flex-col items-center gap-1 text-forest w-16 transition-colors touch-target">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-xs font-medium">Home</span>
        </button>
        <button onclick="openSearch()" class="flex flex-col items-center gap-1 text-gray-400 hover:text-forest w-16 transition-colors touch-target">
            <i data-lucide="search" class="w-6 h-6"></i>
            <span class="text-xs font-medium">Search</span>
        </button>
        <button onclick="openAuthModal()" class="flex flex-col items-center gap-1 text-gray-400 hover:text-forest w-16 transition-colors touch-target">
            <i id="user-icon-mobile" data-lucide="user" class="w-6 h-6"></i>
            <span class="text-xs font-medium">Account</span>
        </button>
    </nav>

    <!-- CART DRAWER -->
    <div id="cart-drawer" class="fixed inset-0 z-[60] flex justify-end pointer-events-none opacity-0 invisible transition-all duration-300">
        <div class="absolute inset-0 bg-dark/20 backdrop-blur-sm" onclick="closeModal('cart-drawer')"></div>
        <div class="bg-white w-full max-w-md h-full shadow-2xl pointer-events-auto flex flex-col transform translate-x-full transition-transform duration-300">
            <div class="p-6 flex justify-between items-center bg-white border-b border-gray-100 sticky top-0 z-10">
                <h3 class="text-xl font-serif font-bold text-forest flex items-center gap-2">
                    <div class="w-9 h-9 rounded-full bg-mint flex items-center justify-center text-leaf">
                        <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                    </div>
                    My Basket
                </h3>
                <button onclick="closeModal('cart-drawer')" class="p-2 rounded-full hover:bg-gray-100 text-forest/60 transition-colors touch-target">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="cart-items-container" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-50/50"></div>
            <div class="p-6 bg-white border-t border-gray-100 mt-auto">
                <div class="flex justify-between items-baseline mb-4">
                    <span class="text-gray-500 text-sm font-medium">Total Estimate</span>
                    <span id="cart-total-price" class="text-2xl font-bold text-forest">₹0.00</span>
                </div>
                <button onclick="processCheckout()" class="w-full bg-leaf text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:bg-[#6ec248] transition-colors btn-large touch-target">
                    Checkout on WhatsApp
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-24 right-4 md:right-8 z-[80] bg-white/90 backdrop-blur-md border border-gray-200 shadow-lg rounded-xl p-4 flex items-center gap-3 translate-x-[150%] transition-transform duration-300 max-w-[90vw] w-auto">
        <div class="w-8 h-8 rounded-full bg-leaf text-white flex items-center justify-center shrink-0 shadow-sm">
            <i data-lucide="check" class="w-4 h-4"></i>
        </div>
        <div>
            <h4 class="font-bold text-forest text-sm" id="toast-title">Success</h4>
            <p class="text-xs text-gray-500" id="toast-message">Action completed.</p>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // Global variables
        let state = {
            cart: JSON.parse(localStorage.getItem('ls_cart')) || [],
            user: JSON.parse(localStorage.getItem('ls_user')) || null,
            userDetails: JSON.parse(localStorage.getItem('ls_user_details')) || null,
            currentItem: null,
            tempQty: 1,
            confirmationResult: null,
            recaptchaVerifier: null,
            resendTimer: null,
            resendTimeLeft: 60
        };

        // Product data
        const products = [
            { id: 1, type: 'fruit-seeds', name: "Heirloom Tomato", price: 120, originalPrice: 150, img: "https://images.unsplash.com/photo-1592841200221-a6898f307baa?q=80&w=600&auto=format&fit=crop", desc: "Juicy, rich-flavored tomatoes perfect for salads and sauces.", germ: "98%", time: "60 Days", rating: 4.8 },
            { id: 2, type: 'vegetable-seeds', name: "Spicy Chilli", price: 80, originalPrice: 95, img: "https://images.unsplash.com/photo-1588252303782-cb80119abd6d?q=80&w=600&auto=format&fit=crop", desc: "High heat variety, excellent for adding kick to your dishes.", germ: "95%", time: "75 Days", rating: 4.6 },
            { id: 3, type: 'plant-seeds', name: "Fresh Coriander", price: 45, originalPrice: null, img: "https://images.unsplash.com/photo-1596043225276-2afc36c2d0b9?q=80&w=600&auto=format&fit=crop", desc: "Aromatic herb essential for garnishing and cooking.", germ: "90%", time: "35 Days", rating: 4.5 },
            { id: 4, type: 'fruit-seeds', name: "Sweet Strawberry", price: 180, originalPrice: 220, img: "https://images.unsplash.com/photo-1543528176-61b239494933?q=80&w=600&auto=format&fit=crop", desc: "Red, sweet berries that grow well in pots or ground.", germ: "85%", time: "90 Days", rating: 4.9 },
            { id: 5, type: 'vegetable-seeds', name: "Crunchy Carrot", price: 95, originalPrice: 110, img: "https://images.unsplash.com/photo-1598170845058-78131a90f4a6?q=80&w=600&auto=format&fit=crop", desc: "Vitamin-rich roots with a satisfying crunch.", germ: "92%", time: "70 Days", rating: 4.7 },
            { id: 6, type: 'plant-seeds', name: "Holy Basil", price: 60, originalPrice: null, img: "https://images.unsplash.com/photo-1618331835717-801e976710b2?q=80&w=600&auto=format&fit=crop", desc: "Sacred medicinal plant known for immunity boosting.", germ: "88%", time: "45 Days", rating: 4.8 },
            { id: 7, type: 'fruit-seeds', name: "Watermelon", price: 110, originalPrice: 140, img: "https://images.unsplash.com/photo-1589596660126-e75c5e317c2f?q=80&w=600&auto=format&fit=crop", desc: "Summer favorite, grows large and sweet.", germ: "85%", time: "85 Days", rating: 4.5 },
            { id: 8, type: 'vegetable-seeds', name: "Spinach", price: 55, originalPrice: 70, img: "https://images.unsplash.com/photo-1576045057995-568f588f82fb?q=80&w=600&auto=format&fit=crop", desc: "Iron-packed leafy green, grows quickly.", germ: "95%", time: "40 Days", rating: 4.4 },
        ];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loader after 1.5 seconds
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    renderGrid('all');
                    updateBadges();
                    initializeAuthListener();
                    lucide.createIcons();
                }, 500);
            }, 1500);
        });

        // ========== OTP AUTHENTICATION FUNCTIONS ==========

        function openPhoneOTPModal() {
            closeAuthModal();
            const modal = document.getElementById('phone-otp-modal');
            modal.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
            modal.classList.add('opacity-100');
            
            const content = modal.querySelector('div.relative');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
            
            // Initialize reCAPTCHA
            initializeRecaptcha();
        }

        function closePhoneOTPModal() {
            const modal = document.getElementById('phone-otp-modal');
            if (modal) {
                const content = modal.querySelector('div.relative');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('invisible', 'pointer-events-none');
                }, 300);
            }
        }

        function initializeRecaptcha() {
            // Clear previous reCAPTCHA
            const container = document.getElementById('recaptcha-container');
            container.innerHTML = '';
            
            // Initialize reCAPTCHA verifier
            try {
                state.recaptchaVerifier = new window.firebaseAuth.RecaptchaVerifier(
                    'recaptcha-container', 
                    {
                        'size': 'invisible',
                        'callback': () => {
                            // This will be called when reCAPTCHA is solved
                            console.log('reCAPTCHA solved');
                        }
                    }
                );
            } catch (error) {
                console.error('reCAPTCHA initialization error:', error);
                showToast('Error', 'reCAPTCHA failed to load. Please refresh.');
            }
        }

        async function sendOTP(event) {
            event.preventDefault();
            
            const phoneNumber = document.getElementById('phone-number').value.trim();
            const sendBtn = document.getElementById('send-otp-btn');
            
            // Validate phone number format
            if (!phoneNumber.match(/^\+[1-9]\d{1,14}$/)) {
                showToast('Error', 'Please enter a valid phone number with country code (e.g., +91 9876543210)');
                return;
            }
            
            try {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending OTP...';
                
                // Ensure reCAPTCHA is initialized
                if (!state.recaptchaVerifier) {
                    initializeRecaptcha();
                }
                
                // Send OTP
                const appVerifier = state.recaptchaVerifier;
                const auth = window.firebaseAuth.auth;
                
                state.confirmationResult = await window.firebaseAuth.signInWithPhoneNumber(
                    auth, 
                    phoneNumber, 
                    appVerifier
                );
                
                // Show OTP verification stage
                document.getElementById('phone-input-stage').classList.add('hidden');
                document.getElementById('otp-verification-stage').classList.remove('hidden');
                document.getElementById('otp-sent-to').textContent = `Enter the 6-digit code sent to ${phoneNumber}`;
                
                // Clear OTP input and focus
                document.getElementById('otp-code').value = '';
                document.getElementById('otp-code').focus();
                
                // Start resend timer
                startResendTimer();
                
                showToast('OTP Sent', `Verification code sent to ${phoneNumber}`);
                
            } catch (error) {
                console.error('Error sending OTP:', error);
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send OTP';
                
                let errorMessage = 'Failed to send OTP. ';
                switch (error.code) {
                    case 'auth/invalid-phone-number':
                        errorMessage += 'Invalid phone number format.';
                        break;
                    case 'auth/quota-exceeded':
                        errorMessage += 'SMS quota exceeded. Try again later.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += 'Too many requests. Try again later.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showToast('Error', errorMessage);
                
                // Reset reCAPTCHA
                if (state.recaptchaVerifier) {
                    state.recaptchaVerifier.clear();
                    initializeRecaptcha();
                }
            }
        }

        async function verifyOTP(event) {
            event.preventDefault();
            
            const otpCode = document.getElementById('otp-code').value.trim();
            const verifyBtn = document.getElementById('verify-otp-btn');
            
            if (otpCode.length !== 6) {
                showToast('Error', 'Please enter a 6-digit OTP code');
                return;
            }
            
            try {
                verifyBtn.disabled = true;
                verifyBtn.textContent = 'Verifying...';
                
                // Verify OTP
                const result = await state.confirmationResult.confirm(otpCode);
                const user = result.user;
                
                // Get or create user profile
                const phoneNumber = user.phoneNumber;
                const userRef = window.firebaseAuth.ref(window.firebaseAuth.database, `users/${user.uid}`);
                const snapshot = await window.firebaseAuth.get(userRef);
                
                let userDetails = snapshot.val();
                
                if (!userDetails) {
                    // Create new user profile
                    userDetails = {
                        phone: phoneNumber,
                        name: `User ${phoneNumber.substring(phoneNumber.length - 4)}`,
                        createdAt: new Date().toISOString()
                    };
                    await window.firebaseAuth.set(userRef, userDetails);
                }
                
                // Update state
                state.user = {
                    uid: user.uid,
                    phone: phoneNumber,
                    displayName: userDetails.name
                };
                state.userDetails = userDetails;
                
                // Save to localStorage
                localStorage.setItem('ls_user', JSON.stringify(state.user));
                localStorage.setItem('ls_user_details', JSON.stringify(userDetails));
                
                // Update UI
                updateUIForUser();
                closePhoneOTPModal();
                showToast('Welcome!', `Logged in with ${phoneNumber}`);
                
                // Stop resend timer
                if (state.resendTimer) {
                    clearInterval(state.resendTimer);
                }
                
            } catch (error) {
                console.error('Error verifying OTP:', error);
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify OTP';
                
                let errorMessage = 'Invalid OTP. ';
                if (error.code === 'auth/invalid-verification-code') {
                    errorMessage += 'The code is incorrect.';
                } else if (error.code === 'auth/code-expired') {
                    errorMessage += 'The code has expired. Please resend.';
                } else {
                    errorMessage += error.message;
                }
                
                showToast('Error', errorMessage);
            }
        }

        function resendOTP() {
            const phoneNumber = document.getElementById('phone-number').value.trim();
            if (!phoneNumber) {
                showToast('Error', 'Phone number is required');
                return;
            }
            
            // Trigger send OTP again
            const event = new Event('submit');
            document.getElementById('phone-form').dispatchEvent(event);
        }

        function startResendTimer() {
            const resendBtn = document.getElementById('resend-otp-btn');
            const timerSpan = document.getElementById('resend-timer');
            
            resendBtn.disabled = true;
            state.resendTimeLeft = 60;
            timerSpan.textContent = state.resendTimeLeft;
            
            if (state.resendTimer) {
                clearInterval(state.resendTimer);
            }
            
            state.resendTimer = setInterval(() => {
                state.resendTimeLeft--;
                timerSpan.textContent = state.resendTimeLeft;
                
                if (state.resendTimeLeft <= 0) {
                    clearInterval(state.resendTimer);
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'Resend OTP';
                }
            }, 1000);
        }

        function showPhoneInputStage() {
            document.getElementById('otp-verification-stage').classList.add('hidden');
            document.getElementById('phone-input-stage').classList.remove('hidden');
            document.getElementById('phone-number').focus();
            
            // Clear OTP input
            document.getElementById('otp-code').value = '';
            
            // Stop resend timer
            if (state.resendTimer) {
                clearInterval(state.resendTimer);
            }
            
            const resendBtn = document.getElementById('resend-otp-btn');
            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend OTP';
        }

        // ========== OTHER AUTH FUNCTIONS ==========

        function openAuthModal() {
            const modal = document.getElementById('auth-modal');
            modal.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
            modal.classList.add('opacity-100');
            
            const content = modal.querySelector('div.relative');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }

        function closeAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                const content = modal.querySelector('div.relative');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('invisible', 'pointer-events-none');
                }, 300);
            }
        }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (tab === 'login') {
                loginTab.classList.add('text-forest', 'border-forest');
                loginTab.classList.remove('text-gray-400');
                registerTab.classList.remove('text-forest', 'border-forest');
                registerTab.classList.add('text-gray-400');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('text-forest', 'border-forest');
                registerTab.classList.remove('text-gray-400');
                loginTab.classList.remove('text-forest', 'border-forest');
                loginTab.classList.add('text-gray-400');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        async function signInWithGoogle() {
            try {
                const result = await window.firebaseAuth.signInWithPopup(
                    window.firebaseAuth.auth, 
                    window.firebaseAuth.googleProvider
                );
                const user = result.user;
                
                // Save user details to database
                const userRef = window.firebaseAuth.ref(window.firebaseAuth.database, `users/${user.uid}`);
                const snapshot = await window.firebaseAuth.get(userRef);
                let userDetails = snapshot.val();
                
                if (!userDetails) {
                    userDetails = {
                        name: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        phone: '',
                        address: '',
                        createdAt: new Date().toISOString()
                    };
                    await window.firebaseAuth.set(userRef, userDetails);
                }
                
                // Update state
                state.user = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                };
                state.userDetails = userDetails;
                
                localStorage.setItem('ls_user', JSON.stringify(state.user));
                localStorage.setItem('ls_user_details', JSON.stringify(userDetails));
                
                updateUIForUser();
                closeAuthModal();
                showToast('Welcome!', `Hello ${user.displayName || user.email}`);
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                showToast('Error', error.message);
            }
        }

        async function loginWithEmail(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const userCredential = await window.firebaseAuth.signInWithEmailAndPassword(
                    window.firebaseAuth.auth, 
                    email, 
                    password
                );
                const user = userCredential.user;
                
                // Load user details
                const userRef = window.firebaseAuth.ref(window.firebaseAuth.database, `users/${user.uid}`);
                const snapshot = await window.firebaseAuth.get(userRef);
                const userDetails = snapshot.val();
                
                state.user = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || email.split('@')[0]
                };
                state.userDetails = userDetails || {
                    name: '',
                    phone: '',
                    address: '',
                    email: user.email
                };
                
                localStorage.setItem('ls_user', JSON.stringify(state.user));
                localStorage.setItem('ls_user_details', JSON.stringify(state.userDetails));
                
                updateUIForUser();
                closeAuthModal();
                showToast('Welcome Back!', `Good to see you again`);
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login Failed', error.message);
            }
        }

        async function registerWithEmail(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const firstName = document.getElementById('register-firstname').value;
            const lastName = document.getElementById('register-lastname').value;
            const phone = document.getElementById('register-phone').value;
            const address = document.getElementById('register-address').value;
            
            if (password.length < 6) {
                showToast('Error', 'Password must be at least 6 characters');
                return;
            }
            
            try {
                const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(
                    window.firebaseAuth.auth, 
                    email, 
                    password
                );
                const user = userCredential.user;
                
                // Save user details to database
                const userDetails = {
                    name: `${firstName} ${lastName}`,
                    phone: phone,
                    address: address,
                    email: email,
                    createdAt: new Date().toISOString()
                };
                
                await window.firebaseAuth.set(
                    window.firebaseAuth.ref(window.firebaseAuth.database, `users/${user.uid}`), 
                    userDetails
                );
                
                // Update profile
                await user.updateProfile({
                    displayName: `${firstName} ${lastName}`
                });
                
                state.user = {
                    uid: user.uid,
                    email: user.email,
                    displayName: `${firstName} ${lastName}`
                };
                state.userDetails = userDetails;
                
                localStorage.setItem('ls_user', JSON.stringify(state.user));
                localStorage.setItem('ls_user_details', JSON.stringify(userDetails));
                
                updateUIForUser();
                closeAuthModal();
                showToast('Welcome!', `Account created successfully`);
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast('Registration Failed', error.message);
            }
        }

        function showForgotPassword() {
            closeAuthModal();
            const modal = document.getElementById('forgot-password-modal');
            modal.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
            modal.classList.add('opacity-100');
            
            const content = modal.querySelector('div.relative');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }

        function closeForgotPassword() {
            const modal = document.getElementById('forgot-password-modal');
            if (modal) {
                const content = modal.querySelector('div.relative');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('invisible', 'pointer-events-none');
                }, 300);
            }
        }

        async function resetPassword(event) {
            event.preventDefault();
            const email = document.getElementById('reset-email').value;
            
            try {
                await window.firebaseAuth.sendPasswordResetEmail(
                    window.firebaseAuth.auth, 
                    email
                );
                closeForgotPassword();
                showToast('Email Sent', 'Check your inbox for reset instructions');
                
            } catch (error) {
                console.error('Password reset error:', error);
                showToast('Error', error.message);
            }
        }

        async function logout() {
            try {
                await window.firebaseAuth.signOut(window.firebaseAuth.auth);
                state.user = null;
                state.userDetails = null;
                localStorage.removeItem('ls_user');
                localStorage.removeItem('ls_user_details');
                updateUIForUser();
                showToast('Logged Out', 'See you soon!');
                
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function updateUIForUser() {
            const userProfile = document.getElementById('user-profile');
            const loginButton = document.getElementById('login-button');
            const userIconMobile = document.getElementById('user-icon-mobile');
            
            if (state.user) {
                userProfile.classList.remove('hidden');
                loginButton.classList.add('hidden');
                
                document.getElementById('user-name').textContent = 
                    state.user.displayName || state.user.email?.split('@')[0] || 'User';
                
                const avatar = document.getElementById('user-avatar');
                if (state.user.photoURL) {
                    avatar.innerHTML = `<img src="${state.user.photoURL}" class="w-full h-full rounded-full object-cover">`;
                } else {
                    const initials = state.user.displayName ? 
                        state.user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) :
                        'U';
                    avatar.textContent = initials;
                }
                
                if (userIconMobile) {
                    userIconMobile.setAttribute('data-lucide', 'user-check');
                    lucide.createIcons();
                }
            } else {
                userProfile.classList.add('hidden');
                loginButton.classList.remove('hidden');
                
                if (userIconMobile) {
                    userIconMobile.setAttribute('data-lucide', 'user');
                    lucide.createIcons();
                }
            }
        }

        function initializeAuthListener() {
            window.firebaseAuth.onAuthStateChanged(window.firebaseAuth.auth, (user) => {
                if (user) {
                    state.user = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        phone: user.phoneNumber
                    };
                    
                    // Load user details from database
                    window.firebaseAuth.get(
                        window.firebaseAuth.ref(window.firebaseAuth.database, `users/${user.uid}`)
                    ).then((snapshot) => {
                        const userDetails = snapshot.val();
                        state.userDetails = userDetails;
                        localStorage.setItem('ls_user', JSON.stringify(state.user));
                        localStorage.setItem('ls_user_details', JSON.stringify(userDetails || {}));
                        updateUIForUser();
                    });
                } else {
                    state.user = null;
                    state.userDetails = null;
                    localStorage.removeItem('ls_user');
                    localStorage.removeItem('ls_user_details');
                    updateUIForUser();
                }
            });
        }

        // ========== PRODUCT FUNCTIONS ==========

        function renderGrid(filter) {
            const grid = document.getElementById('product-grid');
            const data = filter === 'all' ? products : products.filter(p => p.type === filter);
            
            const countBadge = document.getElementById('item-count-badge');
            if (countBadge) countBadge.innerText = data.length;

            grid.innerHTML = data.map((p, idx) => `
                <div class="group bg-white rounded-2xl p-3 border border-gray-100 hover:border-leaf/30 shadow-sm hover:shadow-lg transition-all duration-300 cursor-pointer animate-fade-in" 
                     style="animation-delay: ${idx * 0.03}s"
                     onclick="openProduct(${p.id})">
                    <div class="aspect-[4/5] rounded-xl overflow-hidden relative bg-gray-100 mb-3">
                        <img src="${p.img}" loading="lazy" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                        ${p.originalPrice ? `<div class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded shadow-sm">- ${Math.round(100 - (p.price/p.originalPrice)*100)}%</div>` : ''}
                    </div>
                    <div class="px-1">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-bold text-forest text-base leading-tight line-clamp-1 group-hover:text-leaf transition-colors">${p.name}</h3>
                            <div class="flex items-center gap-0.5 text-xs font-bold text-yellow-500 bg-yellow-50 px-1.5 py-0.5 rounded">
                                <i data-lucide="star" class="w-3 h-3 fill-current"></i> ${p.rating}
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-2">${p.type.replace('-', ' ')}</p>
                        <div class="flex items-baseline gap-2">
                            <span class="text-lg font-bold text-forest">₹${p.price}</span>
                            ${p.originalPrice ? `<span class="text-xs text-gray-400 line-through">₹${p.originalPrice}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function openProduct(id) {
            // This would open product modal - simplified for brevity
            showToast('Product', `Opening product ${id}`);
        }

        function filterProducts(type) {
            renderGrid(type);
            scrollToGrid();
        }

        function scrollToGrid() {
            document.getElementById('grid-anchor').scrollIntoView({behavior: 'smooth'});
        }

        // ========== CART FUNCTIONS ==========

        function updateBadges() {
            const cartCount = state.cart.reduce((a,b) => a + (b.qty || 0), 0);
            const cartBadge = document.getElementById('cart-badge');
            cartBadge.innerText = cartCount;
            if (cartCount > 0) {
                cartBadge.classList.remove('opacity-0', 'scale-0');
            } else {
                cartBadge.classList.add('opacity-0', 'scale-0');
            }
        }

        function saveState() {
            localStorage.setItem('ls_cart', JSON.stringify(state.cart));
            updateBadges();
        }

        function openCart() {
            // Simplified cart opening
            showToast('Cart', 'Cart functionality would open here');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('invisible', 'pointer-events-none');
                }, 300);
            }
        }

        function processCheckout() {
            if (!state.userDetails || !state.userDetails.phone || !state.userDetails.address) {
                showToast('Info Required', 'Please update your profile with phone and address');
                openAuthModal();
                return;
            }
            
            // Simplified checkout
            showToast('Checkout', 'Redirecting to WhatsApp...');
        }

        // ========== UTILITY FUNCTIONS ==========

        function showToast(title, msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-message').innerText = msg;
            
            toast.style.transform = 'translateX(0)';
            setTimeout(() => {
                toast.style.transform = 'translateX(150%)';
            }, 3000);
        }

        function openSearch() {
            showToast('Search', 'Search functionality would open here');
        }

        // Initialize icons
        lucide.createIcons();
    </script>
</body>
</html>
