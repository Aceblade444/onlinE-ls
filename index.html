<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2A593E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Lightsprouts | Premium Seeds & Plants</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        forest: '#2A593E',        
                        leaf: '#7ED957',          
                        lime: '#D1FFBD',          
                        mint: '#F0FFE9',          
                        sand: '#fcfdfa',
                        dark: '#081C15',
                    },
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(42, 89, 62, 0.15)',
                        'glow': '0 0 20px rgba(126, 217, 87, 0.4)',
                        'nav': '0 -4px 20px rgba(0,0,0,0.05)',
                        'float': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-in-right': 'slideInRight 0.3s ease-out forwards',
                        'leaf-wiggle': 'leafWiggle 2s ease-in-out infinite',
                        'gentle-pulse': 'gentlePulse 3s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideInRight: { 'from': { transform: 'translateX(100%)', opacity: '0' }, 'to': { transform: 'translateX(0)', opacity: '1' } },
                        leafWiggle: { 
                            '0%, 100%': { transform: 'rotate(-5deg) scale(1)' }, 
                            '50%': { transform: 'rotate(5deg) scale(1.05)' } 
                        },
                        gentlePulse: { '0%, 100%': { opacity: 0.8 }, '50%': { opacity: 1 } },
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            background-color: #fcfdfa;
            color: #2A593E;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }

        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            pointer-events: none;
        }
        
        .img-wrapper {
            position: relative;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        .tap-active:active { transform: scale(0.96); transition: transform 0.1s; }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        .loader-container {
            background: #F0FFE9;
        }
        
        .big-btn {
            min-height: 56px;
            font-size: 1.1rem;
        }

        .modal-enter {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-enter.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-enter .sheet-content {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-enter.active .sheet-content {
            transform: translateY(0);
        }

        .order-badge {
            background: linear-gradient(135deg, #7ED957 0%, #2A593E 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .history-item {
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
            background: rgba(240, 255, 233, 0.5);
        }

        /* Slide out animation for cart item removal */
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .removing {
            animation: slideOut 0.3s ease forwards;
        }

        /* For You badge styling */
        .for-you-badge {
            background: linear-gradient(135deg, #7ED957 0%, #2A593E 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 10;
        }
    </style>
</head>
<body class="font-sans antialiased min-h-screen relative flex flex-col pb-24 md:pb-0" oncontextmenu="return false;">

    <!-- LOADING SCREEN -->
    <div id="loader" class="fixed inset-0 z-[100] bg-[#fcfdfa] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative w-24 h-24 mb-6">
            <svg class="w-full h-full text-forest animate-float" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22v-14" />
                <path d="M12 8c0-3.3-2-6-5.5-6S1 4.7 1 8c0 2 1.3 3.8 3 4.8" />
                <path d="M12 8c0-3.3 2-6 5.5-6S23 4.7 23 8c0 2-1.3 3.8-3 4.8" />
                <path d="M12 22c4.3 0 8-2.5 8-7" />
            </svg>
            <div class="absolute inset-0 bg-gradient-to-tr from-transparent to-white/50 animate-pulse rounded-full"></div>
        </div>
        <h1 class="text-3xl font-serif font-bold text-forest tracking-tight">lightsprouts<span class="text-leaf text-3xl leading-none">.</span></h1>
        <div class="mt-4 flex gap-2">
            <span class="w-2 h-2 bg-forest rounded-full animate-bounce" style="animation-delay: 0ms"></span>
            <span class="w-2 h-2 bg-leaf rounded-full animate-bounce" style="animation-delay: 150ms"></span>
            <span class="w-2 h-2 bg-lime rounded-full animate-bounce" style="animation-delay: 300ms"></span>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 z-[999] flex items-center justify-center px-4 pointer-events-none opacity-0 invisible transition-all duration-300">
        <div class="absolute inset-0 bg-forest/90 backdrop-blur-sm" onclick="closeAuthModal()"></div>
        
        <div class="relative w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-all duration-300 pointer-events-auto flex flex-col max-h-[90vh] overflow-y-auto">
            
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 z-30 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-forest hover:bg-forest hover:text-white transition-all tap-active">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div class="flex border-b border-gray-100 sticky top-0 bg-white z-20">
                <button id="login-tab" class="flex-1 py-5 text-center font-bold text-lg text-forest border-b-4 border-forest transition-all" onclick="switchAuthTab('login')">
                    Login
                </button>
                <button id="register-tab" class="flex-1 py-5 text-center font-bold text-lg text-gray-400 transition-all" onclick="switchAuthTab('register')">
                    Register
                </button>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="p-8">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-serif font-bold text-forest">Welcome Back</h3>
                </div>

                <form onsubmit="loginWithEmail(event)" class="space-y-4">
                    <input type="email" id="login-email" required placeholder="Email Address" 
                           class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-4 text-forest text-lg focus:outline-none focus:border-leaf transition-all placeholder:text-gray-400">
                    <input type="password" id="login-password" required placeholder="Password" 
                           class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-4 text-forest text-lg focus:outline-none focus:border-leaf transition-all placeholder:text-gray-400">
                    
                    <button type="submit" class="w-full bg-forest text-white font-bold py-4 rounded-xl text-lg shadow-lg tap-active hover:bg-[#1e3f2d] big-btn">
                        Sign In
                    </button>
                </form>

                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="mx-4 text-gray-400 text-sm">OR</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <button onclick="signInWithGoogle()" class="w-full bg-white border border-gray-200 text-forest font-bold py-4 rounded-xl flex items-center justify-center gap-3 tap-active big-btn">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/></svg>
                    Continue with Google
                </button>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="p-8 hidden">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-serif font-bold text-forest">Create Account</h3>
                </div>

                <form onsubmit="registerWithEmail(event)" class="space-y-4">
                    <input type="text" id="reg-name" required placeholder="Full Name" 
                           class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:border-leaf">
                    
                    <input type="tel" id="reg-phone" required placeholder="Phone Number" 
                           class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:border-leaf">
                    
                    <textarea id="reg-address" required rows="2" placeholder="Delivery Address" 
                              class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:border-leaf resize-none"></textarea>

                    <div class="border-t border-gray-100 my-2"></div>

                    <input type="email" id="reg-email" required placeholder="Email Address" 
                           class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:border-leaf">
                    
                    <input type="password" id="reg-password" required placeholder="Create Password" 
                           class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3.5 text-forest focus:outline-none focus:border-leaf">
                    
                    <button type="submit" class="w-full bg-leaf text-forest font-bold py-4 rounded-xl text-lg shadow-lg tap-active hover:bg-[#6ec248] big-btn">
                        Register & Save Details
                    </button>
                </form>

                 <div class="mt-4 text-center">
                    <button onclick="signInWithGoogle()" class="text-forest font-semibold text-sm underline">Or use Google</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="fixed inset-0 z-[999] flex items-center justify-center px-4 pointer-events-none opacity-0 invisible transition-all duration-300">
        <div class="absolute inset-0 bg-forest/90 backdrop-blur-sm" onclick="closeProfileModal()"></div>
        
        <div class="relative w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-all duration-300 pointer-events-auto flex flex-col max-h-[90vh] overflow-y-auto">
            
            <button onclick="closeProfileModal()" class="absolute top-4 right-4 z-30 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-forest hover:bg-forest hover:text-white transition-all tap-active">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <!-- Profile Header -->
            <div class="bg-gradient-to-r from-forest to-leaf p-8 text-white">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center text-2xl font-bold border-4 border-white/30" id="profile-avatar">
                        U
                    </div>
                    <div>
                        <h3 id="profile-name" class="text-2xl font-bold">User Name</h3>
                        <p id="profile-email" class="text-white/80 text-sm">user@email.com</p>
                    </div>
                </div>
                <button onclick="logout()" class="mt-4 px-4 py-2 bg-white/20 rounded-full text-sm font-bold hover:bg-white/30 transition-colors">
                    Logout
                </button>
            </div>

            <!-- Profile Details -->
            <div class="p-6">
                <h4 class="text-lg font-bold text-forest mb-4 flex items-center gap-2">
                    <i data-lucide="user" class="w-5 h-5"></i>
                    Personal Information
                </h4>
                <div class="space-y-3 mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="phone" class="w-4 h-4 text-gray-400"></i>
                        <span id="profile-phone" class="text-gray-600">+91 00000 00000</span>
                    </div>
                    <div class="flex items-start gap-3">
                        <i data-lucide="map-pin" class="w-4 h-4 text-gray-400 mt-1"></i>
                        <span id="profile-address" class="text-gray-600">Delivery address will appear here</span>
                    </div>
                </div>

                <!-- Purchase History -->
                <h4 class="text-lg font-bold text-forest mb-4 flex items-center gap-2">
                    <i data-lucide="history" class="w-5 h-5"></i>
                    Purchase History
                </h4>
                <div id="purchase-history" class="space-y-3 max-h-60 overflow-y-auto">
                    <!-- History items will be inserted here -->
                    <p class="text-gray-400 text-center py-4">No purchases yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- APP HEADER -->
    <header class="fixed top-0 left-0 w-full z-40 bg-white/90 backdrop-blur-xl border-b border-gray-100 shadow-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-16 flex justify-between items-center relative">
            
            <!-- Logo -->
            <a href="#" onclick="window.scrollTo(0,0); playSound('click'); return false;" class="text-2xl font-serif font-bold text-forest flex items-center gap-1 tap-active select-none">
                <i data-lucide="sprout" class="w-6 h-6 text-leaf fill-current"></i>
                lightsprouts
            </a>

            <!-- Desktop Filter Menu -->
            <nav class="hidden lg:flex items-center gap-2 bg-gray-100/50 p-1.5 rounded-full border border-gray-200">
                <button onclick="filterProducts('all')" class="nav-pill px-5 py-2 rounded-full text-sm font-bold bg-white text-forest shadow-sm">All</button>
                <button onclick="filterProducts('fruit-seeds')" class="nav-pill px-5 py-2 rounded-full text-sm font-semibold text-gray-500 hover:bg-white/50">Fruits</button>
                <button onclick="filterProducts('vegetable-seeds')" class="nav-pill px-5 py-2 rounded-full text-sm font-semibold text-gray-500 hover:bg-white/50">Veg</button>
                <button onclick="filterProducts('flower-plants')" class="nav-pill px-5 py-2 rounded-full text-sm font-semibold text-gray-500 hover:bg-white/50">Flowers</button>
                <button onclick="filterProducts('plants')" class="nav-pill px-5 py-2 rounded-full text-sm font-semibold text-gray-500 hover:bg-white/50">Plants</button>
                <button onclick="filterProducts('spices')" class="nav-pill px-5 py-2 rounded-full text-sm font-semibold text-gray-500 hover:bg-white/50">Spices</button>
            </nav>

            <!-- Actions -->
            <div class="flex items-center gap-3">
                <div id="user-profile" class="hidden items-center gap-2">
                    <button onclick="openProfileModal()" class="w-10 h-10 rounded-full bg-mint flex items-center justify-center text-leaf font-bold hover:bg-leaf hover:text-white transition-colors" id="user-avatar">U</button>
                </div>

                <button id="login-button" onclick="openAuthModal()" class="px-4 py-2 rounded-full text-sm font-bold bg-forest/5 text-forest hover:bg-forest hover:text-white transition-colors">
                    Login
                </button>

                <button onclick="openCart()" class="relative w-10 h-10 flex items-center justify-center rounded-full bg-forest text-white shadow-glow tap-active">
                    <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                    <span id="cart-badge" class="absolute -top-1 -right-1 bg-leaf text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center scale-0 transition-transform">0</span>
                </button>
            </div>
        </div>

        <!-- Mobile Sticky Categories -->
        <div class="lg:hidden w-full border-t border-gray-100 py-3 px-4 overflow-x-auto no-scrollbar flex gap-2">
            <button onclick="filterProducts('all')" class="cat-pill shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-forest text-white shadow-sm transition-all">All</button>
            <button onclick="filterProducts('fruit-seeds')" class="cat-pill shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-white text-forest border border-gray-200">Fruits</button>
            <button onclick="filterProducts('vegetable-seeds')" class="cat-pill shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-white text-forest border border-gray-200">Veg</button>
            <button onclick="filterProducts('flower-plants')" class="cat-pill shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-white text-forest border border-gray-200">Flowers</button>
            <button onclick="filterProducts('plants')" class="cat-pill shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-white text-forest border border-gray-200">Plants</button>
            <button onclick="filterProducts('spices')" class="cat-pill shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-white text-forest border border-gray-200">Spices</button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow pt-32 lg:pt-24 px-4 sm:px-6 w-full max-w-7xl mx-auto z-10 relative">
        
        <!-- Hero Section -->
        <section class="relative w-full h-[40vh] md:h-[400px] rounded-[2rem] overflow-hidden mb-8 shadow-float group img-wrapper">
            <img src="https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?q=80&w=2070&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover transition-transform duration-[4s] group-hover:scale-105">
            <div class="absolute inset-0 bg-gradient-to-t from-dark/80 to-transparent"></div>
            
            <div class="absolute bottom-0 left-0 w-full p-8 flex flex-col items-start text-white">
                <span class="bg-leaf text-forest text-xs font-extrabold px-3 py-1 rounded-full uppercase tracking-wider mb-2">Organic</span>
                <h1 class="text-4xl md:text-5xl font-serif font-bold mb-2 leading-tight">
                    Grow your own <br><span class="text-lime italic">paradise.</span>
                </h1>
                <p class="text-white/80 text-sm mb-4">Premium Plants & Seeds • 95% Germination • Fast Delivery</p>
            </div>
        </section>

        <!-- Product Grid -->
        <div id="grid-header" class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-forest">Fresh Plants & Seeds</h2>
            <span id="item-count" class="text-xs font-bold text-gray-400">Loading...</span>
        </div>

        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 mb-24">
            <!-- Items injected via JS -->
        </div>

    </main>

    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-xl border-t border-gray-200 z-40 pb-[calc(10px+var(--safe-bottom))] pt-3 flex justify-around items-center shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'}); playSound('click')" class="flex flex-col items-center gap-1 text-forest w-16 tap-active">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Home</span>
        </button>
        <button onclick="openSearch()" class="flex flex-col items-center gap-1 text-gray-400 hover:text-forest w-16 tap-active">
            <i data-lucide="search" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Search</span>
        </button>
        <button onclick="openAccount()" class="flex flex-col items-center gap-1 text-gray-400 hover:text-forest w-16 tap-active">
            <i id="user-icon-mobile" data-lucide="user" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Account</span>
        </button>
    </nav>

    <!-- PRODUCT DETAIL MODAL -->
    <div id="product-modal" class="fixed inset-0 z-50 flex items-end md:items-center justify-center pointer-events-none modal-enter">
        <div class="absolute inset-0 bg-dark/60 backdrop-blur-sm transition-opacity" onclick="closeModal('product-modal')"></div>
        
        <div class="sheet-content pointer-events-auto bg-[#FAFAF9] w-full md:w-[900px] rounded-t-[2.5rem] md:rounded-[2.5rem] shadow-2xl flex flex-col md:flex-row overflow-hidden relative max-h-[90vh]">
            
            <button onclick="closeModal('product-modal')" class="absolute top-4 right-4 z-20 bg-white/80 p-2 rounded-full text-forest shadow-sm tap-active">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <!-- Image Side -->
            <div class="w-full md:w-1/2 h-72 md:h-auto bg-gray-100 relative img-wrapper">
                <img id="modal-img" src="" class="w-full h-full object-cover">
            </div>

            <!-- Content Side -->
            <div class="w-full md:w-1/2 p-6 md:p-10 flex flex-col bg-white overflow-y-auto pb-10">
                <div class="mb-2">
                    <span id="modal-tag" class="text-xs font-bold uppercase tracking-widest text-leaf">Category</span>
                </div>
                
                <h2 id="modal-title" class="text-3xl font-serif font-bold text-forest mb-2">Product Name</h2>
                <div class="flex items-baseline gap-3 mb-6">
                    <span id="modal-price" class="text-3xl font-bold text-forest">₹0</span>
                    <span id="modal-original-price" class="text-gray-400 line-through decoration-red-400">₹0</span>
                </div>

                <p id="modal-desc" class="text-gray-500 text-sm leading-relaxed mb-8 font-medium">Description...</p>

                <!-- Actions -->
                <div class="mt-auto space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center bg-gray-50 border border-gray-200 rounded-2xl px-2 h-14 shrink-0">
                            <button onclick="adjustQty(-1)" class="w-10 h-full flex items-center justify-center text-forest text-xl font-bold">-</button>
                            <span id="qty-display" class="w-8 text-center font-bold text-forest text-lg">1</span>
                            <button onclick="adjustQty(1)" class="w-10 h-full flex items-center justify-center text-forest text-xl font-bold">+</button>
                        </div>
                        
                        <!-- Add to Cart -->
                        <button onclick="addToCart()" class="flex-grow h-14 bg-forest text-white font-bold rounded-2xl shadow-lg shadow-forest/20 tap-active text-lg flex items-center justify-center gap-2">
                            Add to Cart
                        </button>
                    </div>

                    <!-- Direct Buy Button -->
                    <button onclick="directBuy()" class="w-full h-14 bg-leaf text-forest font-extrabold rounded-2xl shadow-lg shadow-leaf/20 tap-active text-lg flex items-center justify-center gap-2 uppercase tracking-wide">
                        Buy Now (WhatsApp) <i data-lucide="message-circle" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CART/CHECKOUT DRAWER -->
    <div id="cart-drawer" class="fixed inset-0 z-[60] flex justify-end pointer-events-none modal-enter">
        <div class="absolute inset-0 bg-dark/20 backdrop-blur-sm transition-opacity" onclick="closeModal('cart-drawer')"></div>
        <div class="sheet-content bg-[#FAFAF9] w-full max-w-md h-full shadow-2xl pointer-events-auto flex flex-col translate-x-full transition-transform duration-300">
            
            <div class="p-5 flex justify-between items-center bg-white border-b border-gray-100">
                <h3 class="text-xl font-bold text-forest">My Basket</h3>
                <button onclick="closeModal('cart-drawer')" class="p-2 bg-gray-100 rounded-full hover:bg-red-50 hover:text-red-500 text-forest transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="cart-items-container" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-50"></div>

            <div class="p-6 bg-white border-t border-gray-100 pb-8">
                <div class="flex justify-between items-baseline mb-4">
                    <span class="text-gray-500 font-medium">Total</span>
                    <span id="cart-total-price" class="text-3xl font-bold text-forest">₹0.00</span>
                </div>
                <!-- Checkout with logic -->
                <button onclick="handleCheckout()" class="w-full bg-leaf text-forest font-extrabold py-5 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-leaf/20 tap-active text-lg uppercase big-btn">
                    Checkout on WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- DELIVERY DETAILS MODAL -->
    <div id="delivery-modal" class="fixed inset-0 z-[80] flex items-center justify-center p-4 pointer-events-none modal-enter">
        <div class="absolute inset-0 bg-forest/90 backdrop-blur-md transition-opacity" onclick="closeModal('delivery-modal')"></div>
        <div class="sheet-content pointer-events-auto bg-white rounded-3xl w-full max-w-md p-8 relative shadow-2xl scale-95 opacity-0 transition-all duration-300">
            
            <button onclick="closeModal('delivery-modal')" class="absolute top-4 right-4 p-2 text-gray-400">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <h3 class="text-2xl font-serif font-bold text-forest mb-2">One Last Thing</h3>
            <p class="text-gray-400 mb-6">Where should we send your plants?</p>

            <form onsubmit="saveAndProceedCheckout(event)" class="space-y-4">
                <input type="text" id="d-name" required placeholder="Full Name" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-4 text-forest text-lg">
                <input type="tel" id="d-phone" required placeholder="Phone Number" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-4 text-forest text-lg">
                <textarea id="d-address" required rows="2" placeholder="Full Address" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-4 text-forest text-lg resize-none"></textarea>
                
                <button type="submit" class="w-full bg-forest text-white font-bold py-4 rounded-xl mt-4 text-lg shadow-lg tap-active">
                    Confirm & Order
                </button>
            </form>
        </div>
    </div>

    <!-- SEARCH MODAL -->
    <div id="search-modal" class="fixed inset-0 z-[90] bg-white/95 backdrop-blur-xl modal-enter flex flex-col">
        <div class="pt-6 px-4 pb-4 border-b border-gray-100 flex items-center gap-3">
            <button onclick="closeModal('search-modal')" class="p-2"><i data-lucide="arrow-left" class="text-forest"></i></button>
            <input type="text" id="search-input" placeholder="Search..." class="flex-grow bg-transparent text-xl font-bold text-forest placeholder:text-gray-300 focus:outline-none" oninput="handleSearch(this.value)">
        </div>
        <div id="search-results" class="flex-grow overflow-y-auto p-4 space-y-2"></div>
    </div>

    <script>
        // --- CONFIG & DATA ---
        const firebaseConfig = {
            apiKey: "AIzaSyAHrBE3doAhDni4mcNhylJD8o3r5cNZYSI",
            authDomain: "ls-mannage.firebaseapp.com",
            databaseURL: "https://ls-mannage-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ls-mannage",
            storageBucket: "ls-mannage.firebasestorage.app",
            messagingSenderId: "115534926798",
            appId: "1:115534926798:web:4ea3ab3c1a2d44e2e1d19f",
            measurementId: "G-P2JQH8M41Y"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // WhatsApp Number Configuration
        const WHATSAPP_NUMBER = '9526725376';

        // Product Data
        const products = [
            // Fruits Seeds
            { id: 1, type: 'fruit-seeds', name: "Heirloom Tomato", price: 120, originalPrice: 150, img: "https://images.unsplash.com/photo-1592841200221-a6898f307baa?q=80&w=600&auto=format&fit=crop", desc: "Juicy, rich-flavored tomatoes." },
            { id: 8, type: 'fruit-seeds', name: "Strawberry", price: 180, originalPrice: 220, img: "https://images.unsplash.com/photo-1543528176-61b239494933?q=80&w=600&auto=format&fit=crop", desc: "Sweet red berries." },
            { id: 9, type: 'fruit-seeds', name: "Watermelon", price: 150, originalPrice: 180, img: "https://images.unsplash.com/photo-1563241527-3004b7be0ff9?q=80&w=600&auto=format&fit=crop", desc: "Sweet summer fruit seeds." },
            
            // Vegetable Seeds
            { id: 2, type: 'vegetable-seeds', name: "Spicy Chilli", price: 80, originalPrice: 95, img: "https://images.unsplash.com/photo-1588252303782-cb80119abd6d?q=80&w=600&auto=format&fit=crop", desc: "High heat variety." },
            { id: 10, type: 'vegetable-seeds', name: "Organic Spinach", price: 60, originalPrice: 75, img: "https://images.unsplash.com/photo-1576045057995-568f588f82fb?q=80&w=600&auto=format&fit=crop", desc: "Iron-rich leafy green." },
            
            // Flowers (Live Plants)
            { id: 11, type: 'flower-plants', name: "Rose Plant (Red)", price: 350, originalPrice: 450, img: "https://images.unsplash.com/photo-1562690868-60bbe7293e94?q=80&w=600&auto=format&fit=crop", desc: "Beautiful red rose live plant." },
            { id: 12, type: 'flower-plants', name: "Jasmine Plant", price: 280, originalPrice: 350, img: "https://images.unsplash.com/photo-1526913299589-b42ef5b26d2f?q=80&w=600&auto=format&fit=crop", desc: "Fragrant jasmine flowering plant." },
            { id: 13, type: 'flower-plants', name: "Sunflower Plant", price: 220, originalPrice: 280, img: "https://images.unsplash.com/photo-1497250681960-ef046c08a56e?q=80&w=600&auto=format&fit=crop", desc: "Bright sunflower live plant." },
            { id: 14, type: 'flower-plants', name: "Orchid Plant", price: 650, originalPrice: 850, img: "https://images.unsplash.com/photo-1545243421-89e4f7c9b9c1?q=80&w=600&auto=format&fit=crop", desc: "Exotic orchid flowering plant." },
            
            // Plants (Fruit/Vegetable Plants)
            { id: 15, type: 'plants', name: "Mango Sapling", price: 450, originalPrice: 550, img: "https://images.unsplash.com/photo-1553279768-865429fa0078?q=80&w=600&auto=format&fit=crop", desc: "Dwarf mango fruit plant." },
            { id: 16, type: 'plants', name: "Lemon Plant", price: 380, originalPrice: 450, img: "https://images.unsplash.com/photo-1547514701-42782101795e?q=80&w=600&auto=format&fit=crop", desc: "Lemon fruit bearing plant." },
            { id: 17, type: 'plants', name: "Brinjal Plant", price: 180, originalPrice: 220, img: "https://images.unsplash.com/photo-1621459570776-50a7c47d7926?q=80&w=600&auto=format&fit=crop", desc: "Brinjal vegetable plant." },
            { id: 7, type: 'plants', name: "Papaya Plant", price: 320, originalPrice: 400, img: "https://images.unsplash.com/photo-1517260739337-6799d2ffdeee?q=80&w=600&auto=format&fit=crop", desc: "Fast growing papaya plant." },
            
            // Spices
            { id: 3, type: 'spices', name: "Fresh Coriander", price: 45, originalPrice: null, img: "https://images.unsplash.com/photo-1596043225276-2afc36c2d0b9?q=80&w=600&auto=format&fit=crop", desc: "Aromatic herb essential." },
            { id: 4, type: 'spices', name: "Black Pepper", price: 200, originalPrice: 250, img: "https://images.unsplash.com/photo-1563503926-d34c11451381?q=80&w=600&auto=format&fit=crop", desc: "King of spices, vine plant." },
            { id: 6, type: 'spices', name: "Cardamom", price: 300, originalPrice: 350, img: "https://images.unsplash.com/photo-1550399434-6c392c68f279?q=80&w=600&auto=format&fit=crop", desc: "The queen of spices." },
        ];

        // Global State
        let state = {
            cart: JSON.parse(localStorage.getItem('ls_cart')) || [],
            user: JSON.parse(localStorage.getItem('ls_user_profile')) || null,
            currentItem: null,
            tempQty: 1,
            purchaseHistory: JSON.parse(localStorage.getItem('ls_purchase_history')) || {},
            userBehavior: JSON.parse(localStorage.getItem('ls_user_behavior')) || {}
        };

        // --- SOUND ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();

        function playSound(type) {
            if(ctx.state === 'suspended') ctx.resume();
            
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            if(type === 'click') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.05, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
                osc.start();
                osc.stop(ctx.currentTime + 0.06);
            } else if (type === 'success') {
                playTone(523.25, 0);
                playTone(659.25, 0.1);
                playTone(783.99, 0.2);
            } else if (type === 'remove') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.04, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
                osc.start();
                osc.stop(ctx.currentTime + 0.15);
            }
        }

        function playTone(freq, delay) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, ctx.currentTime + delay);
            gain.gain.linearRampToValueAtTime(0.05, ctx.currentTime + delay + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.4);
            osc.start(ctx.currentTime + delay);
            osc.stop(ctx.currentTime + delay + 0.5);
        }

        // --- USER BEHAVIOR TRACKING ---
        function trackUserBehavior(action, data) {
            if (!state.user || !state.user.email) return;
            
            const userId = state.user.email;
            const today = new Date().toISOString().split('T')[0];
            
            if (!state.userBehavior[userId]) {
                state.userBehavior[userId] = {
                    searches: [],
                    views: [],
                    purchases: [],
                    categories: {},
                    interests: {},
                    lastUpdated: today
                };
            }
            
            state.userBehavior[userId].lastUpdated = today;
            
            switch(action) {
                case 'search':
                    if (data && !state.userBehavior[userId].searches.includes(data.toLowerCase())) {
                        state.userBehavior[userId].searches.push(data.toLowerCase());
                        if (state.userBehavior[userId].searches.length > 20) {
                            state.userBehavior[userId].searches.shift();
                        }
                    }
                    break;
                    
                case 'view':
                    const viewData = {
                        productId: data.id,
                        category: data.type,
                        name: data.name,
                        timestamp: Date.now()
                    };
                    state.userBehavior[userId].views.unshift(viewData);
                    if (state.userBehavior[userId].views.length > 50) {
                        state.userBehavior[userId].views.pop();
                    }
                    break;
                    
                case 'category_click':
                    const category = data;
                    if (!state.userBehavior[userId].categories[category]) {
                        state.userBehavior[userId].categories[category] = 0;
                    }
                    state.userBehavior[userId].categories[category] += 1;
                    break;
                    
                case 'purchase':
                    data.items.forEach(item => {
                        if (!state.userBehavior[userId].interests[item.type]) {
                            state.userBehavior[userId].interests[item.type] = 0;
                        }
                        state.userBehavior[userId].interests[item.type] += item.qty;
                    });
                    
                    state.userBehavior[userId].purchases.unshift({
                        orderId: data.orderId,
                        items: data.items,
                        total: data.total,
                        timestamp: Date.now()
                    });
                    
                    if (state.userBehavior[userId].purchases.length > 50) {
                        state.userBehavior[userId].purchases.pop();
                    }
                    break;
            }
            
            localStorage.setItem('ls_user_behavior', JSON.stringify(state.userBehavior));
            saveUserBehaviorToFirebase();
        }

        async function saveUserBehaviorToFirebase() {
            if (!state.user || !state.user.email) return;
            
            try {
                const userId = state.user.email.replace(/[.#$\[\]]/g, '_');
                await database.ref('userBehavior/' + userId).set(state.userBehavior[state.user.email]);
            } catch (error) {
                console.log('Firebase offline', error);
            }
        }

        async function loadUserBehaviorFromFirebase() {
            if (!state.user || !state.user.email) return;
            
            try {
                const userId = state.user.email.replace(/[.#$\[\]]/g, '_');
                const snapshot = await database.ref('userBehavior/' + userId).once('value');
                const firebaseData = snapshot.val();
                
                if (firebaseData) {
                    if (!state.userBehavior[state.user.email]) {
                        state.userBehavior[state.user.email] = firebaseData;
                    } else {
                        // Merge searches
                        const localSearches = state.userBehavior[state.user.email].searches || [];
                        const firebaseSearches = firebaseData.searches || [];
                        state.userBehavior[state.user.email].searches = [...new Set([...localSearches, ...firebaseSearches])];
                        
                        // Merge views
                        const localViews = state.userBehavior[state.user.email].views || [];
                        const firebaseViews = firebaseData.views || [];
                        state.userBehavior[state.user.email].views = [...localViews, ...firebaseViews]
                            .sort((a, b) => b.timestamp - a.timestamp)
                            .slice(0, 50);
                        
                        // Merge categories
                        state.userBehavior[state.user.email].categories = {
                            ...(firebaseData.categories || {}),
                            ...(state.userBehavior[state.user.email].categories || {})
                        };
                        
                        // Merge interests
                        state.userBehavior[state.user.email].interests = {
                            ...(firebaseData.interests || {}),
                            ...(state.userBehavior[state.user.email].interests || {})
                        };
                        
                        // Merge purchases
                        const localPurchases = state.userBehavior[state.user.email].purchases || [];
                        const firebasePurchases = firebaseData.purchases || [];
                        state.userBehavior[state.user.email].purchases = [...localPurchases, ...firebasePurchases]
                            .sort((a, b) => b.timestamp - a.timestamp)
                            .slice(0, 50);
                    }
                    
                    localStorage.setItem('ls_user_behavior', JSON.stringify(state.userBehavior));
                }
            } catch (error) {
                console.log('Could not load from Firebase', error);
            }
        }

        // --- PERSONALIZED RECOMMENDATION ALGORITHM ---
        function getPersonalizedProductOrder(products) {
            if (!state.user || !state.userBehavior[state.user.email]) {
                return products;
            }
            
            const userData = state.userBehavior[state.user.email];
            const scoredProducts = products.map(product => {
                let score = 0;
                
                // 1. Category preference (30% weight)
                const categoryWeight = userData.categories[product.type] || 0;
                score += categoryWeight * 30;
                
                // 2. Search relevance (25% weight)
                userData.searches.forEach(searchTerm => {
                    if (product.name.toLowerCase().includes(searchTerm) || 
                        product.type.toLowerCase().includes(searchTerm)) {
                        score += 25;
                    }
                });
                
                // 3. Purchase interest (20% weight)
                const interestWeight = userData.interests[product.type] || 0;
                score += interestWeight * 20;
                
                // 4. Recent views (15% weight)
                const recentView = userData.views.find(view => view.productId === product.id);
                if (recentView) {
                    const daysAgo = (Date.now() - recentView.timestamp) / (1000 * 60 * 60 * 24);
                    if (daysAgo < 7) score += 15;
                    else if (daysAgo < 30) score += 8;
                }
                
                // 5. Purchase history similarity (10% weight)
                userData.purchases.forEach(purchase => {
                    purchase.items.forEach(item => {
                        if (item.type === product.type) score += 10;
                    });
                });
                
                return { ...product, score };
            });
            
            scoredProducts.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.price - a.price;
            });
            
            return scoredProducts.map(p => {
                const { score, ...product } = p;
                return product;
            });
        }

        // --- AUTH & USER LOGIC ---
        function openAuthModal() {
            playSound('click');
            const m = document.getElementById('auth-modal');
            m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
            m.querySelector('div.relative').classList.remove('scale-95');
        }

        function closeAuthModal() {
            playSound('click');
            const m = document.getElementById('auth-modal');
            m.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            m.querySelector('div.relative').classList.add('scale-95');
        }

        function openProfileModal() {
            playSound('click');
            if (!state.user) {
                openAuthModal();
                return;
            }
            
            updateProfileModal();
            const m = document.getElementById('profile-modal');
            m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
            m.querySelector('div.relative').classList.remove('scale-95');
        }

        function closeProfileModal() {
            playSound('click');
            const m = document.getElementById('profile-modal');
            m.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            m.querySelector('div.relative').classList.add('scale-95');
        }

        function updateProfileModal() {
            if (!state.user) return;
            
            const userEmail = state.user.email;
            document.getElementById('profile-name').textContent = state.user.name || 'User Name';
            document.getElementById('profile-email').textContent = userEmail || 'user@email.com';
            document.getElementById('profile-phone').textContent = state.user.phone || '+91 00000 00000';
            document.getElementById('profile-address').textContent = state.user.address || 'No address saved';
            document.getElementById('profile-avatar').textContent = state.user.name ? state.user.name[0].toUpperCase() : 'U';
            
            // Load purchase history
            const userId = state.user.uid || userEmail;
            const userHistory = state.purchaseHistory[userId] || [];
            const historyContainer = document.getElementById('purchase-history');
            
            if (userHistory.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No purchases yet</p>';
            } else {
                historyContainer.innerHTML = userHistory.map(order => `
                    <div class="history-item bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h5 class="font-bold text-forest">Order #${order.orderId}</h5>
                                <p class="text-xs text-gray-500">${new Date(order.timestamp).toLocaleDateString()}</p>
                            </div>
                            <span class="order-badge">₹${order.total}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>${order.items.length} item(s) • ${order.status || 'Delivered'}</p>
                            <p class="text-xs text-gray-400 mt-1">${order.address.substring(0, 50)}...</p>
                        </div>
                    </div>
                `).join('');
            }
            
            // Show preferences section
            if (state.userBehavior[userEmail]) {
                const userData = state.userBehavior[userEmail];
                const topCategories = Object.entries(userData.categories || {})
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                
                const topInterests = Object.entries(userData.interests || {})
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                
                const preferencesHTML = `
                    <div class="preferences-section mt-6 pt-6 border-t border-gray-100">
                        <h4 class="text-lg font-bold text-forest mb-4 flex items-center gap-2">
                            <i data-lucide="brain" class="w-5 h-5"></i>
                            Your Preferences
                        </h4>
                        <div class="space-y-3">
                            ${topCategories.length > 0 ? `
                                <div>
                                    <p class="text-sm font-medium text-gray-500 mb-1">Top Categories:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${topCategories.map(([cat, count]) => `
                                            <span class="px-3 py-1 bg-mint text-forest text-xs rounded-full">
                                                ${cat.replace('-', ' ')} (${count})
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${topInterests.length > 0 ? `
                                <div>
                                    <p class="text-sm font-medium text-gray-500 mb-1">Frequent Buys:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${topInterests.map(([type, qty]) => `
                                            <span class="px-3 py-1 bg-leaf/20 text-forest text-xs rounded-full">
                                                ${type.replace('-', ' ')} (${qty} items)
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${userData.searches && userData.searches.length > 0 ? `
                                <div>
                                    <p class="text-sm font-medium text-gray-500 mb-1">Recent Searches:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${userData.searches.slice(-5).map(term => `
                                            <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                                ${term}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                const modalContent = document.querySelector('#profile-modal .p-6');
                const existingPrefs = modalContent.querySelector('.preferences-section');
                if (existingPrefs) existingPrefs.remove();
                modalContent.insertAdjacentHTML('beforeend', preferencesHTML);
                lucide.createIcons();
            }
        }

        function switchAuthTab(tab) {
            playSound('click');
            const lTab = document.getElementById('login-tab');
            const rTab = document.getElementById('register-tab');
            const lForm = document.getElementById('login-form');
            const rForm = document.getElementById('register-form');

            if(tab === 'login') {
                lTab.classList.add('border-forest', 'text-forest'); lTab.classList.remove('text-gray-400');
                rTab.classList.remove('border-forest', 'text-forest'); rTab.classList.add('text-gray-400');
                lForm.classList.remove('hidden'); rForm.classList.add('hidden');
            } else {
                rTab.classList.add('border-forest', 'text-forest'); rTab.classList.remove('text-gray-400');
                lTab.classList.remove('border-forest', 'text-forest'); lTab.classList.add('text-gray-400');
                rForm.classList.remove('hidden'); lForm.classList.add('hidden');
            }
        }

        async function registerWithEmail(e) {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const address = document.getElementById('reg-address').value;

            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                const profile = {
                    uid: cred.user.uid,
                    email: email,
                    name: name,
                    phone: phone,
                    address: address
                };
                localStorage.setItem('ls_user_profile', JSON.stringify(profile));
                state.user = profile;
                
                // Initialize user behavior
                if (!state.userBehavior[email]) {
                    state.userBehavior[email] = {
                        searches: [],
                        views: [],
                        purchases: [],
                        categories: {},
                        interests: {},
                        lastUpdated: new Date().toISOString().split('T')[0]
                    };
                    localStorage.setItem('ls_user_behavior', JSON.stringify(state.userBehavior));
                }
                
                updateUI();
                closeAuthModal();
                playSound('success');
                setTimeout(() => {
                    openProfileModal();
                }, 500);
            } catch (err) {
                alert(err.message);
            }
        }

        async function loginWithEmail(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                const cred = await auth.signInWithEmailAndPassword(email, pass);
                let savedProfile = JSON.parse(localStorage.getItem('ls_user_profile'));
                if(!savedProfile || savedProfile.email !== email) {
                    savedProfile = { uid: cred.user.uid, email: email, name: email.split('@')[0], phone: '', address: '' };
                    localStorage.setItem('ls_user_profile', JSON.stringify(savedProfile));
                }
                state.user = savedProfile;
                
                // Load user behavior from Firebase
                await loadUserBehaviorFromFirebase();
                
                updateUI();
                closeAuthModal();
                playSound('success');
                
                // Show personalized welcome
                setTimeout(() => {
                    if (state.userBehavior[email] && state.userBehavior[email].searches.length > 0) {
                        showNotification(`Welcome back! We've personalized products based on your interest in "${state.userBehavior[email].searches.slice(-1)[0]}"`);
                    }
                }, 1000);
            } catch (err) {
                alert(err.message);
            }
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const u = result.user;
                let savedProfile = JSON.parse(localStorage.getItem('ls_user_profile'));
                if(!savedProfile || savedProfile.email !== u.email) {
                    savedProfile = { uid: u.uid, email: u.email, name: u.displayName, phone: '', address: '' };
                    localStorage.setItem('ls_user_profile', JSON.stringify(savedProfile));
                }
                state.user = savedProfile;
                
                // Load user behavior from Firebase
                await loadUserBehaviorFromFirebase();
                
                updateUI();
                closeAuthModal();
                playSound('success');
                
                // Show personalized welcome
                setTimeout(() => {
                    if (state.userBehavior[u.email] && state.userBehavior[u.email].searches.length > 0) {
                        showNotification(`Welcome back ${u.displayName}! Personalized picks ready for you.`);
                    } else {
                        showNotification(`Welcome ${u.displayName}! Start exploring and we'll learn your preferences.`);
                    }
                }, 1000);
            } catch(err) { 
                console.error(err);
                alert('Google sign in failed. Please try again.');
            }
        }

        function logout() {
            auth.signOut();
            state.user = null;
            localStorage.removeItem('ls_user_profile');
            updateUI();
            closeProfileModal();
            playSound('click');
        }

        function openAccount() {
            if (state.user) {
                openProfileModal();
            } else {
                openAuthModal();
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-24 right-4 bg-forest text-white px-6 py-3 rounded-xl shadow-lg z-[1000] animate-slide-up flex items-center gap-2 max-w-xs';
            notification.innerHTML = `
                <i data-lucide="sparkles" class="w-5 h-5 text-leaf flex-shrink-0"></i>
                <span class="text-sm">${message}</span>
            `;
            document.body.appendChild(notification);
            
            lucide.createIcons();
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // --- PURCHASE HISTORY MANAGEMENT ---
        function savePurchase(orderData) {
            if (!state.user) return;
            
            const userId = state.user.uid || state.user.email;
            if (!state.purchaseHistory[userId]) {
                state.purchaseHistory[userId] = [];
            }
            
            state.purchaseHistory[userId].unshift(orderData);
            
            if (state.purchaseHistory[userId].length > 10) {
                state.purchaseHistory[userId].pop();
            }
            
            localStorage.setItem('ls_purchase_history', JSON.stringify(state.purchaseHistory));
            
            // Track purchase behavior
            trackUserBehavior('purchase', orderData);
        }

        // --- PRODUCT GRID & FILTERING ---
        function filterProducts(type) {
            playSound('click');
            const btns = document.querySelectorAll('.cat-pill, .nav-pill');
            btns.forEach(b => {
                b.classList.remove('bg-forest', 'text-white');
                b.classList.add('bg-white', 'text-gray-500', 'text-forest');
            });

            // Track category click
            if (type !== 'all') {
                trackUserBehavior('category_click', type);
            }

            // Highlight active button
            const activeBtn = Array.from(btns).find(btn => 
                btn.textContent.toLowerCase().includes(type === 'all' ? 'all' : type.split('-')[0].toLowerCase())
            );
            if (activeBtn) {
                activeBtn.classList.add('bg-forest', 'text-white');
                activeBtn.classList.remove('bg-white', 'text-gray-500', 'text-forest');
            }

            const grid = document.getElementById('product-grid');
            let data = type === 'all' ? products : products.filter(p => p.type === type);
            
            // Apply personalization for 'all' category
            if (type === 'all') {
                data = getPersonalizedProductOrder(data);
            }
            
            document.getElementById('item-count').innerText = `${data.length} Items`;
            
            grid.innerHTML = data.map((p, i) => `
                <div class="group bg-white rounded-2xl p-2 border border-transparent shadow-sm hover:shadow-soft transition-all duration-300 tap-active animate-slide-up img-wrapper relative" 
                     style="animation-delay: ${i*0.05}s" onclick="openProduct(${p.id})">
                    ${type === 'all' && state.user && i < 3 && state.userBehavior[state.user.email] && 
                     state.userBehavior[state.user.email].searches.length > 0 ? `
                        <div class="for-you-badge flex items-center gap-1">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> For You
                        </div>
                    ` : ''}
                    <div class="aspect-[4/5] rounded-xl overflow-hidden relative bg-gray-100 mb-3">
                        <img src="${p.img}" loading="lazy" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        ${p.originalPrice ? `
                            <div class="absolute top-2 right-2 bg-red-500 text-white text-[10px] px-2 py-1 rounded-full font-bold">
                                SALE
                            </div>
                        ` : ''}
                    </div>
                    <div class="px-1">
                        <h3 class="font-bold text-forest text-sm truncate">${p.name}</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1">${p.type.replace('-', ' ')}</p>
                        <div class="flex items-center gap-2">
                            <span class="text-base font-bold text-forest">₹${p.price}</span>
                            ${p.originalPrice ? `<span class="text-xs text-gray-300 line-through">₹${p.originalPrice}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function openProduct(id) {
            playSound('click');
            const p = products.find(x => x.id === id);
            if (!p) return;
            
            state.currentItem = p;
            state.tempQty = 1;

            // Track product view
            trackUserBehavior('view', p);

            document.getElementById('modal-img').src = p.img;
            document.getElementById('modal-title').innerText = p.name;
            document.getElementById('modal-price').innerText = `₹${p.price}`;
            document.getElementById('modal-original-price').innerText = p.originalPrice ? `₹${p.originalPrice}` : '';
            document.getElementById('modal-desc').innerText = p.desc;
            document.getElementById('modal-tag').innerText = p.type.replace('-', ' ');
            document.getElementById('qty-display').innerText = '1';

            const m = document.getElementById('product-modal');
            m.classList.add('active');
        }

        // --- CART & CHECKOUT LOGIC ---
        function addToCart() {
            if (!state.currentItem) return;
            
            const existing = state.cart.find(i => i.id === state.currentItem.id);
            if(existing) existing.qty += state.tempQty;
            else state.cart.push({...state.currentItem, qty: state.tempQty});
            
            saveCart();
            closeModal('product-modal');
            playSound('success');
            
            const badge = document.getElementById('cart-badge');
            badge.classList.remove('scale-0');
            badge.classList.add('scale-125');
            setTimeout(() => badge.classList.remove('scale-125'), 200);
        }

        function directBuy() {
            if (!state.currentItem) return;
            
            const existing = state.cart.find(i => i.id === state.currentItem.id);
            if(existing) existing.qty += state.tempQty;
            else state.cart.push({...state.currentItem, qty: state.tempQty});
            saveCart();
            closeModal('product-modal');
            handleCheckout();
        }

        function handleCheckout() {
            playSound('click');
            if(state.cart.length === 0) {
                showNotification('Your cart is empty!');
                return;
            }

            if(state.user && state.user.name && state.user.phone && state.user.address) {
                sendToWhatsApp(state.user.name, state.user.phone, state.user.address);
            } else {
                const m = document.getElementById('delivery-modal');
                m.classList.add('active');
                setTimeout(() => {
                    m.querySelector('.sheet-content').classList.remove('scale-95', 'opacity-0');
                }, 10);
            }
        }

        function saveAndProceedCheckout(e) {
            e.preventDefault();
            const name = document.getElementById('d-name').value;
            const phone = document.getElementById('d-phone').value;
            const address = document.getElementById('d-address').value;

            if(state.user) {
                state.user.name = name;
                state.user.phone = phone;
                state.user.address = address;
                localStorage.setItem('ls_user_profile', JSON.stringify(state.user));
            }

            closeModal('delivery-modal');
            sendToWhatsApp(name, phone, address);
        }

        function sendToWhatsApp(name, phone, address) {
            let msg = `*NEW ORDER - LIGHTSPROUTS* 🌱\n`;
            msg += `Customer: ${name}\n`;
            msg += `Phone: ${phone}\n`;
            msg += `Address: ${address}\n\n`;
            msg += `*ORDER DETAILS:*\n`;
            
            let total = 0;
            state.cart.forEach((i, index) => {
                const itemTotal = i.price * i.qty;
                total += itemTotal;
                msg += `${index + 1}. ${i.qty}x ${i.name} - ₹${itemTotal}\n`;
            });
            
            msg += `\n*Subtotal: ₹${total}*\n`;
            msg += `*Shipping: FREE*\n`;
            msg += `*Total: ₹${total}*\n\n`;
            msg += `Please confirm this order.`;

            // Create order record for history
            const orderData = {
                orderId: 'LS' + Date.now().toString().slice(-8),
                timestamp: new Date().toISOString(),
                customerName: name,
                customerPhone: phone,
                address: address,
                items: state.cart.map(item => ({
                    name: item.name,
                    quantity: item.qty,
                    price: item.price,
                    total: item.price * item.qty
                })),
                total: total,
                status: 'Processing'
            };

            // Save to purchase history
            savePurchase(orderData);

            // Clear cart after successful order
            state.cart = [];
            saveCart();
            closeModal('cart-drawer');
            playSound('success');
            
            // Redirect to WhatsApp
            window.open(`https://wa.me/91${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function removeFromCart(productId, element) {
            playSound('remove');
            
            element.closest('.cart-item').classList.add('removing');
            
            setTimeout(() => {
                state.cart = state.cart.filter(item => item.id !== productId);
                saveCart();
                openCart();
            }, 300);
        }

        function openCart() {
            playSound('click');
            const m = document.getElementById('cart-drawer');
            m.classList.add('active');
            setTimeout(() => m.querySelector('.sheet-content').classList.remove('translate-x-full'), 10);
            
            const cont = document.getElementById('cart-items-container');
            let total = 0;
            
            if(state.cart.length === 0) {
                cont.innerHTML = '<div class="text-center py-10"><i data-lucide="shopping-bag" class="w-12 h-12 mx-auto text-gray-300 mb-4"></i><p class="text-gray-400">Your cart is empty</p></div>';
            } else {
                cont.innerHTML = state.cart.map(i => {
                    const itemTotal = i.price * i.qty;
                    total += itemTotal;
                    return `
                    <div class="cart-item flex gap-3 bg-white p-4 rounded-xl border border-gray-100 transition-all duration-300">
                        <img src="${i.img}" class="w-16 h-16 rounded-lg object-cover">
                        <div class="flex-grow">
                            <h4 class="font-bold text-forest text-sm mb-1">${i.name}</h4>
                            <p class="text-xs text-gray-400 mb-2">${i.type.replace('-', ' ')}</p>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center bg-gray-50 border border-gray-200 rounded-lg px-2 h-8">
                                    <button onclick="updateCartQty(${i.id}, -1, this)" class="w-6 h-full flex items-center justify-center text-forest text-sm">-</button>
                                    <span class="w-6 text-center font-bold text-forest text-sm">${i.qty}</span>
                                    <button onclick="updateCartQty(${i.id}, 1, this)" class="w-6 h-full flex items-center justify-center text-forest text-sm">+</button>
                                </div>
                                <span class="font-bold text-forest">₹${itemTotal}</span>
                            </div>
                        </div>
                        <button onclick="removeFromCart(${i.id}, this)" class="text-red-400 hover:text-red-600 p-2 self-start transition-colors tap-active">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>`;
                }).join('');
                
                lucide.createIcons();
            }
            
            document.getElementById('cart-total-price').innerText = `₹${total}`;
        }

        function updateCartQty(productId, delta, button) {
            playSound('click');
            const item = state.cart.find(i => i.id === productId);
            if (item) {
                const newQty = item.qty + delta;
                if (newQty < 1) {
                    removeFromCart(productId, button);
                } else {
                    item.qty = newQty;
                    saveCart();
                    openCart();
                }
            }
        }

        // --- UTILITY FUNCTIONS ---
        function adjustQty(d) {
            if(state.tempQty + d > 0) {
                state.tempQty += d;
                document.getElementById('qty-display').innerText = state.tempQty;
                playSound('click');
            }
        }

        function closeModal(id) {
            playSound('click');
            const m = document.getElementById(id);
            if(id === 'cart-drawer') {
                m.querySelector('.sheet-content').classList.add('translate-x-full');
                setTimeout(() => m.classList.remove('active'), 300);
            } else if (id === 'delivery-modal') {
                m.querySelector('.sheet-content').classList.add('scale-95', 'opacity-0');
                setTimeout(() => m.classList.remove('active'), 300);
            } else if (id === 'profile-modal' || id === 'auth-modal') {
                m.classList.add('opacity-0', 'invisible', 'pointer-events-none');
                m.querySelector('div.relative').classList.add('scale-95');
            } else if (id === 'search-modal') {
                m.classList.remove('active');
                document.getElementById('search-input').value = '';
            } else {
                m.classList.remove('active');
            }
        }

        function openSearch() {
            playSound('click');
            document.getElementById('search-modal').classList.add('active');
            setTimeout(() => document.getElementById('search-input').focus(), 100);
        }

        function handleSearch(q) {
            // Track search query
            trackUserBehavior('search', q);
            
            const res = products.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
            document.getElementById('search-results').innerHTML = res.map(p => `
                <div onclick="closeModal('search-modal'); openProduct(${p.id})" class="flex items-center gap-3 p-2 bg-gray-50 rounded-xl tap-active">
                    <img src="${p.img}" class="w-12 h-12 rounded-lg object-cover">
                    <div><h4 class="font-bold text-forest">${p.name}</h4><p class="text-xs text-gray-500">₹${p.price}</p></div>
                </div>
            `).join('');
        }

        function saveCart() {
            localStorage.setItem('ls_cart', JSON.stringify(state.cart));
            const totalItems = state.cart.reduce((a,b)=>a+b.qty,0);
            const badge = document.getElementById('cart-badge');
            badge.innerText = totalItems;
            if(totalItems > 0) badge.classList.remove('scale-0');
            else badge.classList.add('scale-0');
        }

        function updateUI() {
            const btn = document.getElementById('login-button');
            const profile = document.getElementById('user-profile');
            const avatar = document.getElementById('user-avatar');
            
            if(state.user) {
                btn.classList.add('hidden');
                profile.classList.remove('hidden');
                profile.classList.add('flex');
                avatar.innerText = state.user.name ? state.user.name[0].toUpperCase() : 'U';
                document.getElementById('user-icon-mobile').setAttribute('data-lucide', 'user-check');
            } else {
                btn.classList.remove('hidden');
                profile.classList.add('hidden');
                profile.classList.remove('flex');
                document.getElementById('user-icon-mobile').setAttribute('data-lucide', 'user');
            }
            lucide.createIcons();
        }

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            // Load saved data
            const savedHistory = localStorage.getItem('ls_purchase_history');
            if (savedHistory) {
                state.purchaseHistory = JSON.parse(savedHistory);
            }
            
            const savedBehavior = localStorage.getItem('ls_user_behavior');
            if (savedBehavior) {
                state.userBehavior = JSON.parse(savedBehavior);
            }
            
            setTimeout(() => {
                document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                }, 700);
            }, 1500);
            
            filterProducts('all');
            saveCart();
            updateUI();
            lucide.createIcons();
        });

        // Make functions globally available
        window.openAuthModal = openAuthModal;
        window.closeAuthModal = closeAuthModal;
        window.openProfileModal = openProfileModal;
        window.closeProfileModal = closeProfileModal;
        window.switchAuthTab = switchAuthTab;
        window.loginWithEmail = loginWithEmail;
        window.registerWithEmail = registerWithEmail;
        window.signInWithGoogle = signInWithGoogle;
        window.logout = logout;
        window.openAccount = openAccount;
        window.filterProducts = filterProducts;
        window.openProduct = openProduct;
        window.addToCart = addToCart;
        window.directBuy = directBuy;
        window.handleCheckout = handleCheckout;
        window.saveAndProceedCheckout = saveAndProceedCheckout;
        window.removeFromCart = removeFromCart;
        window.openCart = openCart;
        window.updateCartQty = updateCartQty;
        window.adjustQty = adjustQty;
        window.closeModal = closeModal;
        window.openSearch = openSearch;
        window.handleSearch = handleSearch;
        window.playSound = playSound;
    </script>
</body>
</html>
